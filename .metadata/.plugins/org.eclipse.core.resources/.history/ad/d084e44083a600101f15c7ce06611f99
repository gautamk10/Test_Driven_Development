
#include "stm32f429xx.h"
#include "fpu.h"
#include "uart.h"
#include <stdio.h>
#include <timbase.h>
#include "bsp.h"


#define SECTOR0_BASE_ADDRESS 	0x08000000 /* BootLoader Section*/
#define SECTOR1_BASE_ADDRESS 	0x08004000 /* Default App Section*/
#define SECTOR2_BASE_ADDRESS 	0x08008000 /* APP1 Section*/
#define SECTOR3_BASE_ADDRESS 	0x0800C000 /* Factory App Section*/

#define DEFAULT_APP_ADDRESS		SECTOR1_BASE_ADDRESS
#define APP1_ADDRESS			SECTOR2_BASE_ADDRESS
#define FACTORY_APP_ADDRESS		SECTOR3_BASE_ADDRESS


#define GPIOGEN			(1U<<6)
#define PIN_G13			(1U<<13)
#define LED_GREEN	   	PIN_G13

bool btn_state;
volatile char g_ch_key;
volatile uint8_t g_un_key;

uint8_t button_pressed = 0;

#define EMPTY_MEM				0xFFFFFFFF

typedef void(*func_ptr)(void);


typedef enum
{
	APP1 = 1,
	FACTORY_APP,
}SYS_APPS;

static void process_btldr_cmds(SYS_APPS curr_app);


static void jump_to_app(uint32_t addr_value)
{

	uint32_t app_start_address;
	func_ptr jump_to_app;


	/* Check if firmware available at the location */
	if((*(uint32_t*)addr_value) != EMPTY_MEM)
	{
		printf("Starting Application..\n\r");

		app_start_address = *(uint32_t*)(addr_value + 4);

		jump_to_app = (func_ptr)app_start_address;

		/* Initialize main Stack Pointer*/
		__set_MSP(*(uint32_t*)addr_value);

		/* Jump*/
		jump_to_app();
	}else{
		printf("No Application Found at the Location..\n\r ");

	}
}
int main()
{
	//Enable FPU
	fpu_enable();

	//Initialize UART
	system_uart_init();

	//Initialize the Timebase
	timbase_init();

	//Initialize LED
	led_init();

	//Initilalize Push Button
	button_init();

    printf("\n==============================================\n");
    printf("   Press the button within 5 seconds to enter Bootloader Menu\n");
    printf("==============================================\n");


    for (int i = 5; i > 0; i--)
       {
           printf("Waiting... %d seconds remaining\r\n", i);

           // Delay 1 second (assuming delay_ms exists or use HAL_Delay(1000))
           delay(1);

           // Check button state during countdown
           if (get_btn_state())
           {
               button_pressed = 1;
               break;
           }
       }

	if(get_btn_state())
	{
		/* Button Pressed*/
		printf("Button Pressed\n\r");

		/* Button pressed */

		printf("==============================================\n");
		printf("\n");
		printf("-------BootLoader Menu-------\n");
		printf("\n");
		printf("==============================================\n");

		printf("Available Commands:\n");
		printf("1 ==> Run Application 1\n");
		printf("F/f ==> Factory Application 2\n");
		printf("Any key ==> Run Default Application\n");


		while(1){
			/* TODO: Process BootLoader Commands*/
			process_btldr_cmds(g_un_key);
		}

	}else
	{
		/* Button Not Pressed=> Run Default */
		printf("Button Not Pressed\n\r");
		jump_to_app(DEFAULT_APP_ADDRESS);
	}

	while(1)
	{

	}

}

static void process_btldr_cmds(SYS_APPS curr_app)
{
	switch(curr_app)
	{
	case APP1:
		printf("APP1 Selected\n\r");
		jump_to_app(APP1_ADDRESS);
		break;
	case FACTORY_APP:
		printf("Factory APP Selected\n\r");
		jump_to_app(FACTORY_APP_ADDRESS);
		break;
	default:
		break;

	}
}

static void uart_callback(void)
{
	g_ch_key = USART1->DR;

	if( g_ch_key == '1')
	{
		printf("Key Pressed For APP1\n\r");
		g_un_key = 1;
	}
	else if(g_ch_key == 'F' || g_ch_key == 'f')
	{
		printf("Key Pressed for Factory APP\n\r");
		g_un_key = 2;
	}
	else
	{
		printf("Other key pressed\n\r ");
	}
}

void USART1_IRQHandler(void)
{
	/* Check if RXNE is SET*/

	if(USART1->SR & SR_RXNE)
	{
		uart_callback();
	}
}
