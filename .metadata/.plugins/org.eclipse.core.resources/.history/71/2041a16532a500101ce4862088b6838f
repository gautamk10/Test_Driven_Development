
#include "stm32f429xx.h"
#include "fpu.h"
#include "uart.h"
#include <stdio.h>
#include <timbase.h>
#include "bsp.h"


#define SECTOR0_BASE_ADDRESS 	0x08000000 /* BootLoader Section*/
#define SECTOR1_BASE_ADDRESS 	0x08004000 /* Default App Section*/
#define SECTOR2_BASE_ADDRESS 	0x08008000 /* APP1 Section*/
#define SECTOR3_BASE_ADDRESS 	0x0800C000 /* Factory App Section*/

#define DEFAULT_APP_ADDRESS		SECTOR1_BASE_ADDRESS
#define APP1_ADDRESS			SECTOR2_BASE_ADDRESS
#define FACTORY_APP_ADDRESS		SECTOR3_BASE_ADDRESS


#define GPIOGEN			(1U<<6)
#define PIN_G13			(1U<<13)
#define LED_GREEN	   	PIN_G13

bool btn_state;

#define APPLICATION_ADDRESS 	0x08008000
#define EMPTY_MEM				0xFFFFFFFF

typedef void(*func_ptr)(void);

typedef enum
{
	APP1 = 1,
	FACTORY_APP,
}SYS_APPS;

void jump_to_default_app(void){

	uint32_t app_start_address;
	func_ptr jump_to_app;

	printf("BootLoader Started......\n\r");
	delay(300);

	/* Check if firmware available at the location */
	if((*(uint32_t*)APPLICATION_ADDRESS) != EMPTY_MEM)
	{
		printf("Starting Application..\n\r");

		app_start_address = *(uint32_t*)(APPLICATION_ADDRESS + 4);

		jump_to_app = (func_ptr)app_start_address;

		/* Initialize main Stack Pointer*/
		__set_MSP(*(uint32_t*)APPLICATION_ADDRESS);

		/* Jump*/
		jump_to_app();
	}else{
		printf("No Application Found at the Location..\n\r ");

	}
}

static void jump_to_app(uint32_t addr_value)
{

	uint32_t app_start_address;
	func_ptr jump_to_app;


	/* Check if firmware available at the location */
	if((*(uint32_t*)addr_value) != EMPTY_MEM)
	{
		printf("Starting Application..\n\r");

		app_start_address = *(uint32_t*)(addr_value + 4);

		jump_to_app = (func_ptr)app_start_address;

		/* Initialize main Stack Pointer*/
		__set_MSP(*(uint32_t*)addr_value);

		/* Jump*/
		jump_to_app();
	}else{
		printf("No Application Found at the Location..\n\r ");

	}
}
int main()
{
	//Enable FPU
	fpu_enable();

	//Initialize UART
	system_uart_init();

	//Initialize the Timebase
	timbase_init();

	//Initilize LED
	led_init();

	//Initilalize Push Button
	button_init();

//	jump_to_default_app();

	if(get_btn_state())
	{
		/* Button Pressed*/
		printf("Button Pressed\n\r");

		/* Button pressed */
		printf("==============================================\n");
		printf("==============================================\n");
		printf("==============================================\n");
		printf("==============================================\n");

		printf("==============================================\n");
		printf("\n");
		printf("Bootloader Menu\n");
		printf("\n");
		printf("==============================================\n");
		printf("==============================================\n");
		printf("==============================================\n");
		printf("==============================================\n");

		printf("Available Commands:\n");
		printf("1 ==> Run App 1\n");
		printf("F ==> Factory App 2\n");
		printf("Any key ==> Run Default App\n");


		while(1){
			/* TODO: Process BootLoader Commands*/
		}

	}else
	{
		/* Button Not Pressed=> Run Default */
		printf("Button Not Pressed\n\r");
		jump_to_default_app();
	}

	while(1)
	{

	}

}

static void process_btldr_cmds(SYS_APPS curr_app)
{
	switch(curr_app)
	{
	case APP1:
		jump_to_app(APP1_ADDRESS);
		break;
	case FACTORY_APP:
		jump_to_app(FACTORY_APP_ADDRESS);
		break;
	default:
		jump_to_app(DEFAULT_APP_ADDRESS);
		break;

	}
}
volatile char g_ch_key;
volatile uint8_t g_un_key;

static void uart_callback(void)
{
	g_ch_key = USART1->DR;

	if( g_ch_key == '1')
	{
		printf("Key Pressed : 1\n\r");
		printf("Key Pressed For APP1\n\r");
		g_un_key = 1;
	}
	else if(g_ch_key == 'F' || g_ch_key == 'f')
	{
		printf("Key Pressed for Factory APP\n\r");
	}
	else
	{
		printf("Other key pressed\n\r ");
	}
}

void USART1_IRQHandler(void)
{
	/* Check if RXNE is SET*/

	if(USART1->SR & SR_RXNE)
	{
		uart_callback();
	}
}
